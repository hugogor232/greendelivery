<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Chef - GreenDelivery</title>
    <meta name="description" content="Découvrez les menus et l'histoire de nos chefs locaux.">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Chef Profile Specific Styles */
        .chef-header-section {
            background: linear-gradient(to bottom, var(--bg-light), #fff);
            padding: 4rem 0 2rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .chef-avatar-lg {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #fff;
            box-shadow: var(--shadow-lg);
            margin-bottom: 1.5rem;
        }

        .chef-name {
            font-size: 2.5rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .chef-meta {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            color: var(--text-light);
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        .chef-bio {
            max-width: 700px;
            margin: 0 auto 2rem;
            line-height: 1.6;
            color: var(--text-dark);
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .reviews-list {
            display: grid;
            gap: 1.5rem;
        }

        .review-card {
            background: #fff;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .reviewer-name {
            font-weight: 600;
        }

        .review-date {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .star-rating {
            color: #ffc107;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .chef-name {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>

    <!-- Navigation -->
    <nav class="main-nav">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <i class="fas fa-leaf"></i> GreenDelivery
            </a>
            
            <button class="burger-menu" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <div class="nav-links">
                <a href="index.html">Accueil</a>
                <a href="index.html#marketplace">Plats</a>
                <a href="cart.html">Panier</a>
                <div id="auth-buttons">
                    <a href="login.html" class="btn btn-secondary">Connexion</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Loading State -->
    <div id="loading-container" class="loader-container">
        <div class="loader"></div>
    </div>

    <!-- Error State -->
    <div id="error-container" class="container hidden" style="text-align: center; padding: 5rem 0;">
        <h2>Chef introuvable</h2>
        <p>Le profil que vous recherchez n'existe pas ou n'est plus disponible.</p>
        <a href="index.html" class="btn btn-primary" style="margin-top: 1rem;">Retour à l'accueil</a>
    </div>

    <!-- Main Content -->
    <div id="profile-content" class="hidden">
        
        <!-- Chef Header -->
        <header class="chef-header-section">
            <div class="container">
                <img id="chef-avatar" src="" alt="Chef Avatar" class="chef-avatar-lg">
                <h1 id="chef-name" class="chef-name"></h1>
                
                <div class="chef-meta">
                    <span id="chef-location"><i class="fas fa-map-marker-alt"></i> Localisation inconnue</span>
                    <span id="chef-rating"><i class="fas fa-star text-warning"></i> --/5</span>
                </div>

                <p id="chef-bio" class="chef-bio"></p>
                
                <div class="social-links" style="justify-content: center;">
                    <!-- Optional social links if available in DB -->
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="container">
                
                <!-- Active Menus -->
                <section class="mb-5">
                    <h2 class="section-title"><i class="fas fa-utensils"></i> Menus du moment</h2>
                    <div id="products-grid" class="products-grid">
                        <!-- Products injected here -->
                        <p class="text-light">Aucun plat disponible pour le moment.</p>
                    </div>
                </section>

                <!-- Reviews -->
                <section>
                    <h2 class="section-title"><i class="fas fa-comments"></i> Avis clients</h2>
                    <div id="reviews-list" class="reviews-list">
                        <!-- Reviews injected here -->
                        <p class="text-light">Aucun avis pour le moment.</p>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="footer-col">
                <h4>GreenDelivery</h4>
                <p>La plateforme de livraison qui respecte les hommes et la planète.</p>
            </div>
            <div class="footer-col">
                <h4>Liens utiles</h4>
                <a href="index.html">Accueil</a>
                <a href="cart.html">Mon Panier</a>
                <a href="login.html">Connexion</a>
            </div>
            <div class="footer-col">
                <h4>Contact</h4>
                <p>support@greendelivery.com</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="script.js"></script>
    
    <script type="module">
        import { supabase } from './supabaseClient.js';
        import { checkSession } from './auth-oauth.js';

        // DOM Elements
        const loadingContainer = document.getElementById('loading-container');
        const errorContainer = document.getElementById('error-container');
        const profileContent = document.getElementById('profile-content');
        const authButtons = document.getElementById('auth-buttons');
        
        // Chef Elements
        const elAvatar = document.getElementById('chef-avatar');
        const elName = document.getElementById('chef-name');
        const elLocation = document.getElementById('chef-location');
        const elRating = document.getElementById('chef-rating');
        const elBio = document.getElementById('chef-bio');
        const elProductsGrid = document.getElementById('products-grid');
        const elReviewsList = document.getElementById('reviews-list');

        // Get Chef ID from URL
        const params = new URLSearchParams(window.location.search);
        const chefId = params.get('id');

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Auth Check for Header
            const session = await checkSession();
            if (session) {
                authButtons.innerHTML = `<a href="dashboard.html" class="btn btn-outline">Mon Compte</a>`;
            }

            // 2. Validate ID
            if (!chefId) {
                showError();
                return;
            }

            // 3. Load Data
            await loadChefProfile();
        });

        async function loadChefProfile() {
            try {
                // Fetch Profile
                const { data: chef, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', chefId)
                    .eq('role', 'chef') // Ensure it is a chef
                    .single();

                if (profileError || !chef) throw new Error('Chef not found');

                // Render Header
                renderChefHeader(chef);

                // Fetch Products (Parallel)
                const productsPromise = supabase
                    .from('products')
                    .select('*')
                    .eq('chef_id', chefId)
                    .eq('is_available', true)
                    .order('created_at', { ascending: false });

                // Fetch Reviews (Parallel) - Assuming a 'reviews' table exists
                const reviewsPromise = supabase
                    .from('reviews')
                    .select(`
                        *,
                        profiles:user_id (name, avatar)
                    `)
                    .eq('chef_id', chefId)
                    .order('created_at', { ascending: false });

                const [productsResult, reviewsResult] = await Promise.all([productsPromise, reviewsPromise]);

                // Render Products
                if (productsResult.data && productsResult.data.length > 0) {
                    renderProducts(productsResult.data);
                }

                // Render Reviews
                if (reviewsResult.data && reviewsResult.data.length > 0) {
                    renderReviews(reviewsResult.data);
                    calculateAverageRating(reviewsResult.data);
                } else {
                    elRating.innerHTML = '<i class="fas fa-star text-light"></i> Nouveau';
                }

                // Show Content
                loadingContainer.style.display = 'none';
                profileContent.classList.remove('hidden');

            } catch (err) {
                console.error('Error loading profile:', err);
                showError();
            }
        }

        function renderChefHeader(chef) {
            document.title = `Chef ${chef.name} - GreenDelivery`;
            elName.textContent = chef.name;
            elBio.textContent = chef.bio || "Ce chef n'a pas encore ajouté de biographie.";
            elAvatar.src = chef.avatar || 'https://via.placeholder.com/150?text=Chef';
            
            // Assuming location is stored in metadata or a specific column, or use a default
            // If using PostGIS, we might need to reverse geocode, but for now let's assume a text field or generic
            elLocation.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${chef.city || 'Quartier non précisé'}`;
        }

        function renderProducts(products) {
            elProductsGrid.innerHTML = '';
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'card product-card';
                card.innerHTML = `
                    <div class="card-image">
                        <img src="${product.image_url || 'https://via.placeholder.com/300x200'}" alt="${product.name}" loading="lazy">
                        <span class="badge category">${product.category || 'Plat'}</span>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <h3 class="product-title">${product.name}</h3>
                            <span class="product-price">${product.price} €</span>
                        </div>
                        <p class="product-desc">${product.description ? product.description.substring(0, 60) + '...' : ''}</p>
                        <div class="card-actions">
                            <a href="product-detail.html?id=${product.id}" class="btn btn-sm btn-outline">Voir</a>
                            <button class="btn btn-sm btn-primary" onclick="window.location.href='product-detail.html?id=${product.id}'">
                                <i class="fas fa-plus"></i> Commander
                            </button>
                        </div>
                    </div>
                `;
                elProductsGrid.appendChild(card);
            });
        }

        function renderReviews(reviews) {
            elReviewsList.innerHTML = '';
            reviews.forEach(review => {
                const stars = Array(5).fill(0).map((_, i) => 
                    `<i class="fas fa-star ${i < review.rating ? '' : 'text-light'}" style="${i < review.rating ? 'color: #ffc107;' : 'color: #ddd;'}"></i>`
                ).join('');

                const date = new Date(review.created_at).toLocaleDateString('fr-FR');
                const reviewerName = review.profiles ? review.profiles.name : 'Client Anonyme';

                const reviewEl = document.createElement('div');
                reviewEl.className = 'review-card';
                reviewEl.innerHTML = `
                    <div class="review-header">
                        <span class="reviewer-name">${reviewerName}</span>
                        <span class="review-date">${date}</span>
                    </div>
                    <div class="star-rating">${stars}</div>
                    <p>${review.comment || ''}</p>
                `;
                elReviewsList.appendChild(reviewEl);
            });
        }

        function calculateAverageRating(reviews) {
            const total = reviews.reduce((acc, curr) => acc + curr.rating, 0);
            const avg = (total / reviews.length).toFixed(1);
            elRating.innerHTML = `<i class="fas fa-star text-warning"></i> ${avg}/5 (${reviews.length} avis)`;
        }

        function showError() {
            loadingContainer.style.display = 'none';
            errorContainer.classList.remove('hidden');
        }
    </script>
</body>
</html>